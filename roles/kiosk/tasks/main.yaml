---
# Kiosk role - Browser and X session configuration
- name: Create kiosk wrapper script for retry logic
  ansible.builtin.copy:
    dest: "/home/{{ kiosk_user }}/kiosk.sh"
    owner: "{{ kiosk_user }}"
    group: "{{ kiosk_user }}"
    mode: '0755'
    content: |
      #!/bin/bash
      # Log file for debugging
      LOG_FILE="/home/{{ kiosk_user }}/kiosk.log"
      exec > >(tee -a "$LOG_FILE") 2>&1
      echo "$(date): Kiosk script started"
      # Set DISPLAY environment variable
      export DISPLAY=:0
      # Kill any existing chromium instances
      echo "$(date): Killing existing chromium instances..."
      killall chromium-browser 2>/dev/null || true
      killall chromium 2>/dev/null || true
      sleep 2
      # Remove chromium's SingletonLock to prevent "already running" issues
      echo "$(date): Cleaning up chromium lock files..."
      rm -rf /home/{{ kiosk_user }}/.config/chromium/SingletonLock
      rm -rf /home/{{ kiosk_user }}/.config/chromium/SingletonCookie
      rm -rf /home/{{ kiosk_user }}/.config/chromium/SingletonSocket
      # Wait for network to be up
      echo "$(date): Checking network connectivity..."
      until ping -c 1 {{ home_assistant_ip }} &>/dev/null; do
        echo "$(date): Waiting for network..."
        sleep 2
      done
      echo "$(date): Network is up!"
      # Wait for Home Assistant to be ready (using GET instead of HEAD)
      echo "$(date): Waiting for Home Assistant..."
      MAX_WAIT=12
      for i in $(seq 1 $MAX_WAIT); do
        if curl --output /dev/null --silent --fail --max-time 3 "{{ kiosk_url }}"; then
          echo "$(date): Home Assistant is responding!"
          break
        fi
        echo "$(date): Waiting for Home Assistant... ($i/$MAX_WAIT)"
        sleep 5
      done
      echo "$(date): Launching chromium in kiosk mode..."
      {{ kiosk_browser }} \
        --kiosk \
        --noerrdialogs \
        --disable-infobars \
        --no-first-run \
        --overscroll-history-navigation=0 \
        --disable-breakpad \
        --disable-session-crashed-bubble \
        --disable-restore-session-state \
        --disable-features=TranslateUI \
        --check-for-update-interval=31536000 \
        --password-store=basic \
        --use-mock-keychain \
        --enable-features=TouchTextEditingRedesign \
        --force-tablet-mode=touch \
        --touch-events=enabled \
        --enable-pinch \
        --enable-smooth-scrolling \
        --user-data-dir=/home/{{ kiosk_user }}/.config/chromium-kiosk \
        "{{ kiosk_url }}" >> "$LOG_FILE" 2>&1

- name: Configure X session for kiosk mode
  ansible.builtin.copy:
    dest: "/home/{{ kiosk_user }}/.xinitrc"
    owner: "{{ kiosk_user }}"
    group: "{{ kiosk_user }}"
    mode: '0755'
    content: |
      #!/bin/sh
      # Set DISPLAY
      export DISPLAY=:0

      # Kill gnome-keyring to prevent password prompts
      pkill -9 -f gnome-keyring-daemon 2>/dev/null || true

      # Set keyboard layout
      setxkbmap {{ keyboard_layout }}

      # Configure screen blanking after 10 minutes of inactivity
      xset s 600 600        # Screensaver timeout: 10 minutes
      xset dpms 0 0 600     # DPMS: standby off, suspend off, off after 10 min

      # Hide mouse cursor
      unclutter -idle 0.1 -root &

      # Start window manager
      matchbox-window-manager -use_titlebar no &

      # Wait a bit for X to stabilize
      sleep 2

      # Start floating keyboard button in background
      /home/{{ kiosk_user }}/keyboard-button.sh &

      # Start kiosk script
      /home/{{ kiosk_user }}/kiosk.sh
